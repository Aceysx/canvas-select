!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).CanvasSelect=e()}(this,function(){"use strict";function g(t,e){var a="function"==typeof Symbol&&t[Symbol.iterator];if(!a)return t;var i,r,o=a.call(t),n=[];try{for(;(void 0===e||0<e--)&&!(i=o.next()).done;)n.push(i.value)}catch(t){r={error:t}}finally{try{i&&!i.done&&(a=o.return)&&a.call(o)}finally{if(r)throw r.error}}return n}function t(t){var m=this;this.MIN_WIDTH=20,this.MIN_HEIGHT=20,this.CTRL_R=3,this.EventList=[],this.strokeStyle="#000",this.activeStrokeStyle="#f00",this.remmber={left:0,top:0,right:0,bottom:0},this.ctrlIndex=-1,this.container=document.querySelector(t),this.width=this.container.clientWidth,this.height=this.container.clientHeight,this.canvas=document.createElement("canvas"),this.offlineCanvas=document.createElement("canvas"),this.canvas.width=this.offlineCanvas.width=this.width,this.canvas.height=this.offlineCanvas.height=this.height,this.ctx=this.canvas.getContext("2d"),this.offlineCtx=this.offlineCanvas.getContext("2d"),document.querySelector(t).appendChild(this.canvas),this.canvas.addEventListener("mousedown",function(e){if(m.ctrlIndex=m.ctrlsData.findIndex(function(t){return m.isPointInCtrl([e.offsetX,e.offsetY],t)}),-1<m.ctrlIndex){var t=g(m.ctrlsData[m.ctrlIndex],2),a=t[0],i=t[1];return m.remmber.left=e.offsetX-a,void(m.remmber.top=e.offsetY-i)}m.dataset.reverse();var r=m.dataset.find(function(t){return m.isPointInArea([e.offsetX,e.offsetY],t.coor)});if(m.dataset.reverse(),r){m.dataset.forEach(function(t){return t.active=!1}),r.active=!0,r.dragging=!0;var o=m.dataset.findIndex(function(t){return t===r});m.dataset.splice(o,1),m.dataset.push(r);t=g(r.coor[0],2),a=t[0],i=t[1],o=g(r.coor[1],2),t=o[0],o=o[1];return m.remmber.left=e.offsetX-a,m.remmber.top=e.offsetY-i,m.remmber.right=t-e.offsetX,m.remmber.bottom=o-e.offsetY,m.update(),void m.emit("select",r,e)}m.dataset.forEach(function(t){return t.active=!1}),m.remmber.left=e.offsetX,m.remmber.top=e.offsetY,m.dataset.push(m.parseData({name:"",coor:[[e.offsetX,e.offsetY],[e.offsetX,e.offsetY]],creating:!0},m.dataset.length)),m.update()}),this.canvas.addEventListener("mousemove",function(t){if(1===t.buttons){var e,a,i=m.remmber,r=i.left,o=i.top,n=i.right,s=i.bottom;if(-1<m.ctrlIndex){var c=g(m.activeShapeData.coor,2),h=g(c[0],2),f=h[0],d=h[1],u=g(c[1],2),p=u[0],l=u[1],v=[];switch(m.ctrlIndex){case 0:v=[[t.offsetX-r,t.offsetY-o],[p,l]];break;case 1:v=[[f,t.offsetY-o],[p,l]];break;case 2:v=[[f,t.offsetY-o],[t.offsetX-r,l]];break;case 3:v=[[f,d],[t.offsetX-r,l]];break;case 4:v=[[f,d],[t.offsetX-r,t.offsetY-o]];break;case 5:v=[[f,d],[p,t.offsetY-o]];break;case 6:v=[[t.offsetX-r,d],[p,t.offsetY-o]];break;case 7:v=[[t.offsetX-r,d],[p,l]]}i=g(v,2),h=g(i[0],2),c=h[0],u=h[1],h=g(i[1],2),i=h[0],h=h[1];i-c>=m.MIN_WIDTH&&h-u>=m.MIN_HEIGHT?m.activeShapeData.coor=v:m.emit("error","宽不能小于"+m.MIN_WIDTH+",高不能小于"+m.MIN_HEIGHT)}else m.activeShapeData&&m.activeShapeData.dragging?0<=t.offsetX-r&&t.offsetX+n<=m.width&&0<=t.offsetY-o&&t.offsetY+s<=m.height&&(e=[t.offsetX-r,t.offsetY-o],a=[t.offsetX+n,t.offsetY+s],m.activeShapeData.coor=[e,a]):m.createShapeData&&(e=[r,o],a=[t.offsetX,t.offsetY],m.createShapeData.coor=[e,a]);m.update()}}),this.canvas.addEventListener("mouseup",function(t){m.dataset.forEach(function(t){return t.dragging=!1});var e,a,i,r,o,n=m.dataset.findIndex(function(t){return t.creating});-1<n&&((e=m.dataset[n]).creating=!1,r=g(e.coor,2),a=(i=g(r[0],2))[0],o=i[1],r=(i=g(r[1],2))[0],i=i[1],Math.abs(a-r)<m.MIN_WIDTH||Math.abs(o-i)<m.MIN_HEIGHT?(m.dataset.splice(n,1),m.emit("error","宽不能小于"+m.MIN_WIDTH+",高不能小于"+m.MIN_HEIGHT),m.update()):(r=g(e.coor,2),i=(o=g(r[0],2))[0],n=o[1],r=(o=g(r[1],2))[0],o=o[1],e.coor=[[Math.min(i,r),Math.min(n,o)],[Math.max(i,r),Math.max(n,o)]],m.emit("update",e)))}),document.body.addEventListener("keyup",function(t){var e;"Backspace"===t.code&&t.shiftKey&&(e=m.dataset.findIndex(function(t){return t.active}),(t=m.dataset.find(function(t){return t.active}))&&(m.dataset.splice(e,1),m.update(),m.emit("delete",t)))}),document.body.addEventListener("keydown",function(t){if(t.shiftKey&&m.activeShapeData){var e=g(m.activeShapeData.coor[0],2),a=e[0],i=e[1],e=g(m.activeShapeData.coor[1],2),r=e[0],o=e[1];switch(t.key){case"ArrowDown":m.activeShapeData.coor=[[a,i+1],[r,o+1]];break;case"ArrowUp":m.activeShapeData.coor=[[a,i-1],[r,o-1]];break;case"ArrowLeft":m.activeShapeData.coor=[[a-1,i],[r-1,o]];break;case"ArrowRight":m.activeShapeData.coor=[[a+1,i],[r+1,o]]}m.update()}})}return Object.defineProperty(t.prototype,"activeShapeData",{get:function(){return this.dataset.find(function(t){return t.active})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"createShapeData",{get:function(){return this.dataset.find(function(t){return t.creating})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"ctrlsData",{get:function(){if(this.activeShapeData){var t=g(this.activeShapeData.coor[0],2),e=t[0],t=t[1];return[[e,t],[e+this.activeShapeData.width/2,t],[e+this.activeShapeData.width,t],[e+this.activeShapeData.width,t+this.activeShapeData.height/2],[e+this.activeShapeData.width,t+this.activeShapeData.height],[e+this.activeShapeData.width/2,t+this.activeShapeData.height],[e,t+this.activeShapeData.height],[e,t+this.activeShapeData.height/2]]}return[]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"data",{get:function(){return this.dataset.map(function(t){return{name:t.name,coor:t.coor}})},enumerable:!1,configurable:!0}),t.prototype.isPointInArea=function(t,e){var a=g(e[0],2),i=a[0],r=a[1],a=g(e[1],2),e=a[0],a=a[1];this.offlineCtx.clearRect(0,0,this.width,this.height),this.offlineCtx.fillRect(i,r,e-i,a-r);r=this.offlineCtx.getImageData(0,0,this.width,this.height),t=(t[1]-1)*this.width*4+4*t[0];return 0!=r.data[3+t]},t.prototype.isPointInCtrl=function(t,e){var a=g(e,2),e=a[0],a=a[1];this.offlineCtx.clearRect(0,0,this.width,this.height),this.offlineCtx.beginPath(),this.offlineCtx.arc(e,a,this.CTRL_R,0,2*Math.PI),this.offlineCtx.fill();a=this.offlineCtx.getImageData(0,0,this.width,this.height),t=(t[1]-1)*this.width*4+4*t[0];return 0!=a.data[3+t]},t.prototype.setData=function(t){var a=this;this.dataset=t.map(function(t,e){return a.parseData(t,e)}),this.update()},t.prototype.parseData=function(t,e){var a=this.deepCopy(t),i=a.name,t=a.coor,a=a.creating;return{name:i,index:e,active:!1,creating:Boolean(a),coor:t,get width(){return this.coor[1][0]-this.coor[0][0]},get height(){return this.coor[1][1]-this.coor[0][1]}}},t.prototype.deepCopy=function(t){return JSON.parse(JSON.stringify(t))},t.prototype.drawShape=function(t){var e=g(t.coor,2),a=e[0],e=e[1];this.ctx.save(),this.ctx.strokeStyle=t.active||t.creating?this.activeStrokeStyle:this.strokeStyle,this.ctx.strokeRect(a[0],a[1],e[0]-a[0],e[1]-a[1]),this.ctx.restore(),this.drawLabel(a,t.name)},t.prototype.drawLabel=function(t,e){var a;e.length&&(a=e.length<5?e:e.substr(0,5)+"...",e=this.ctx.measureText(a),this.ctx.save(),this.ctx.fillStyle="#fff",this.ctx.fillRect(t[0]+1,t[1]+1,e.width+4,16),this.ctx.font="12px serif #000",this.ctx.strokeText(a,t[0]+2,t[1]+12,80),this.ctx.restore())},t.prototype.drawCircle=function(t){var e=g(t,2),t=e[0],e=e[1];this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle="#fff",this.ctx.arc(t,e,this.CTRL_R,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.arc(t,e,this.CTRL_R,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore()},t.prototype.clear=function(){this.ctx.clearRect(0,0,this.width,this.height)},t.prototype.update=function(){var e=this;this.clear(),this.dataset.forEach(function(t){return e.drawShape(t)}),this.ctrlsData.forEach(function(t){return e.drawCircle(t)})},t.prototype.deleteByIndex=function(e){var t=this.dataset.findIndex(function(t){return t.index===e});-1<t&&(this.emit("delete",this.dataset[t]),this.dataset.splice(t,1),this.update())},t.prototype.on=function(t,e){var a=this.EventList[t];Array.isArray(a)?a.push(e):this.EventList[t]=[e]},t.prototype.emit=function(t){for(var e=[],a=1;a<arguments.length;a++)e[a-1]=arguments[a];t=this.EventList[t];Array.isArray(t)&&t.forEach(function(t){return t.apply(void 0,function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(g(arguments[e]));return t}(e))})},t.prototype.off=function(t,e){var a=this.EventList[t],t=a.find(function(t){return t===e});Array.isArray(a)&&t&&a.splice(t,1)},t});
