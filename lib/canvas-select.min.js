!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).CanvasSelect=e()}(this,function(){"use strict";function u(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var a,r,s=i.call(t),o=[];try{for(;(void 0===e||0<e--)&&!(a=s.next()).done;)o.push(a.value)}catch(t){r={error:t}}finally{try{a&&!a.done&&(i=s.return)&&i.call(s)}finally{if(r)throw r.error}}return o}var n=(Object.defineProperty(t.prototype,"ctrlsData",{get:function(){var t=u(this.coor,2),e=u(t[0],2),i=e[0],a=e[1],e=u(t[1],2),t=e[0],e=e[1];return[[i,a],[i+(t-i)/2,a],[t,a],[t,a+(e-a)/2],[t,e],[i+(t-i)/2,e],[i,e],[i,a+(e-a)/2]]},enumerable:!1,configurable:!0}),t);function t(t,e){this.label="",this.type=1,this.active=!1,this.creating=!1,this.dragging=!1,this.coor=t,this.index=e}var c=(Object.defineProperty(e.prototype,"ctrlsData",{get:function(){return 2<this.coor.length?this.coor:[]},enumerable:!1,configurable:!0}),e);function e(t,e){this.label="",this.type=2,this.active=!1,this.creating=!1,this.dragging=!1,this.finish=!0,this.coor=t,this.index=e}function h(t){this.MIN_WIDTH=10,this.MIN_HEIGHT=10,this.CTRL_R=5,this.activeStrokeStyle="#f00",this.activeFillStyle="rgba(255, 0, 0,0.1)",this.strokeStyle="rgba(0, 0, 255)",this.fillStyle="rgba(0, 0, 255,0.1)",this.EventList=[],this.dataset=[],this.createType=0,this.ctrlIndex=-1,this.cursor="auto";t="string"==typeof t?document.querySelector(t):t;Object.prototype.toString.call(t).includes("HTMLCanvasElement")?(this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.WIDTH=this.canvas.clientWidth,this.HEIGHT=this.canvas.clientWidth,this.offlineCanvas=document.createElement("canvas"),this.offlineCanvas.width=this.WIDTH,this.offlineCanvas.height=this.HEIGHT,this.offlineCtx=this.offlineCanvas.getContext("2d"),this.init()):this.emit("error","HTMLCanvasElement is required!")}return h.prototype.setData=function(t){var o=this;t.forEach(function(t,e){var i,a=t.label,r=t.type,s=t.coor,t=t.uuid;"number"==typeof r&&0<r?(1===r&&2===s.length&&(i=new n(s,e)),(i=2===r&&2<s.length?new c(s,e):i).label=(a||"").toString(),i.uuid=t||h.createUuid(),o.dataset.push(i)):o.emit("error","type is invalidated")}),this.update()},Object.defineProperty(h.prototype,"activeShape",{get:function(){return this.dataset.find(function(t){return t.active})},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"createShape",{get:function(){return this.dataset.find(function(t){return t.creating})},enumerable:!1,configurable:!0}),h.createUuid=function(){for(var t=[],e="0123456789abcdef",i=0;i<36;i++)t[i]=e.substr(Math.floor(16*Math.random()),1);return t[14]="4",t[19]=e.substr(3&t[19]|8,1),t[8]=t[13]=t[18]=t[23]="-",t.join("")},h.prototype.init=function(){var d=this;this.canvas.style.userSelect="none",this.canvas.addEventListener("mousedown",function(e){if(d.activeShape){var t=d.activeShape.ctrlsData;if(d.ctrlIndex=t.findIndex(function(t){return d.isPointInCtrl([e.offsetX,e.offsetY],t)}),-1<d.ctrlIndex){var i=u(t[d.ctrlIndex],2),a=i[0],i=i[1];return void(d.remmber=[[e.offsetX-a,e.offsetY-i]])}}d.dataset.reverse();var r,s=d.dataset.find(function(t){return d.isPointInArea([e.offsetX,e.offsetY],t)});d.dataset.reverse(),d.dataset.forEach(function(t){t.active=!1}),d.createShape?2===d.createShape.type&&(d.createShape.finish||(i=(a=u(d.createShape.coor[d.createShape.coor.length-1],2))[0],a=a[1],i!==e.offsetX&&a!==e.offsetY&&d.createShape.coor.push([e.offsetX,e.offsetY]))):s?(d.emit("select",s),s.active=!0,s.dragging=!0,r=d.dataset.findIndex(function(t){return t===s}),d.dataset.splice(r,1),d.dataset.push(s),d.remmber=[],s.coor.forEach(function(t){d.remmber.push([e.offsetX-t[0],e.offsetY-t[1]])})):d.createType&&(r=void 0,1===d.createType?r=new n([[e.offsetX,e.offsetY],[e.offsetX,e.offsetY]],d.dataset.length):2===d.createType&&((r=new c([[e.offsetX,e.offsetY]],d.dataset.length)).finish=!1),r.creating=!0,r.uuid=h.createUuid(),d.dataset.push(r)),d.update()}),this.canvas.addEventListener("mousemove",function(t){if(d.movePoint=[t.offsetX,t.offsetY],1===t.buttons)if(-1<d.ctrlIndex){d.emit("resize",d.activeShape);var e=u(d.remmber,1),i=u(e[0],2),a=i[0],r=i[1];if(1===d.activeShape.type){var s=u(d.activeShape.coor,2),o=u(s[0],2),n=o[0],c=o[1],e=u(s[1],2),h=e[0],f=e[1],l=[];switch(d.ctrlIndex){case 0:l=[[t.offsetX-a,t.offsetY-r],[h,f]];break;case 1:l=[[n,t.offsetY-r],[h,f]];break;case 2:l=[[n,t.offsetY-r],[t.offsetX-a,f]];break;case 3:l=[[n,c],[t.offsetX-a,f]];break;case 4:l=[[n,c],[t.offsetX-a,t.offsetY-r]];break;case 5:l=[[n,c],[h,t.offsetY-r]];break;case 6:l=[[t.offsetX-a,c],[h,t.offsetY-r]];break;case 7:l=[[t.offsetX-a,c],[h,f]]}i=u(l,2),o=u(i[0],2),s=o[0],e=o[1],o=u(i[1],2),i=o[0],o=o[1];i-s>=d.MIN_WIDTH&&o-e>=d.MIN_HEIGHT?d.activeShape.coor=l:d.emit("error","宽不能小于"+d.MIN_WIDTH+",高不能小于"+d.MIN_HEIGHT)}else 2===d.activeShape.type&&d.activeShape.coor.splice(d.ctrlIndex,1,[t.offsetX,t.offsetY]);d.update()}else if(d.activeShape&&d.activeShape.dragging){for(var l=[],p=0;p<d.activeShape.coor.length;p++){a=t.offsetX-d.remmber[p][0],r=t.offsetY-d.remmber[p][1];if(a<0||a>d.WIDTH||r<0||r>d.HEIGHT)return;l.push([a,r])}d.activeShape.coor=l,d.update()}else d.createShape&&(1===d.createShape.type&&d.createShape.coor.splice(1,1,[t.offsetX,t.offsetY]),d.update());d.createShape&&d.update()}),this.canvas.addEventListener("mouseup",function(){var t,e,i,a;d.createShape&&1===d.createShape.type&&(i=u(d.createShape.coor,2),t=(a=u(i[0],2))[0],e=a[1],i=(a=u(i[1],2))[0],a=a[1],Math.abs(t-i)<d.MIN_WIDTH||Math.abs(e-a)<d.MIN_HEIGHT?(d.dataset.pop(),d.emit("error","宽不能小于"+d.MIN_WIDTH+",高不能小于"+d.MIN_HEIGHT)):(d.createShape.coor=[[Math.min(t,i),Math.min(e,a)],[Math.max(t,i),Math.max(e,a)]],d.emit("add",d.createShape)),d.dataset.forEach(function(t){t.creating=!1})),d.update(),d.emit("update")}),this.canvas.addEventListener("dblclick",function(){d.createShape&&2===d.createShape.type&&2<d.createShape.coor.length&&(d.emit("add",d.createShape),d.createShape.finish=!0,d.createShape.creating=!1,d.update())}),document.body.addEventListener("keyup",function(t){d.createShape&&2===d.createShape.type&&("Escape"===t.key?d.dataset.pop():"Backspace"===t.key&&(1<d.createShape.coor.length?d.createShape.coor:d.dataset).pop(),d.update());var e=d.createShape||d.activeShape;e&&"Backspace"===t.key&&d.deleteByIndex(e.index)})},h.prototype.isPointInArea=function(t,e){var i,a,r,s,o=this;this.offlineCtx.clearRect(0,0,this.WIDTH,this.HEIGHT),1===e.type?(r=u(e.coor,2),i=(s=u(r[0],2))[0],a=s[1],r=(s=u(r[1],2))[0],s=s[1],this.offlineCtx.fillRect(i,a,r-i,s-a)):2===e.type&&(this.offlineCtx.beginPath(),e.coor.forEach(function(t,e){0===e?o.offlineCtx.moveTo(t[0],t[1]):o.offlineCtx.lineTo(t[0],t[1])}),this.offlineCtx.closePath(),this.offlineCtx.fill());e=this.offlineCtx.getImageData(0,0,this.WIDTH,this.HEIGHT),t=(t[1]-1)*this.WIDTH*4+4*t[0];return 0!==e.data[3+t]},h.prototype.isPointInCtrl=function(t,e){var i=u(e,2),e=i[0],i=i[1];this.offlineCtx.clearRect(0,0,this.WIDTH,this.HEIGHT),this.offlineCtx.beginPath(),this.offlineCtx.arc(e,i,this.CTRL_R,0,2*Math.PI),this.offlineCtx.fill();i=this.offlineCtx.getImageData(0,0,this.WIDTH,this.HEIGHT),t=(t[1]-1)*this.WIDTH*4+4*t[0];return 0!==i.data[3+t]},h.prototype.clear=function(){this.ctx.clearRect(0,0,this.WIDTH,this.HEIGHT)},h.prototype.update=function(){var e=this;this.clear(),this.dataset.forEach(function(t){1===t.type?e.drawRect(t):2===t.type&&e.drawPolygon(t)}),this.activeShape&&this.activeShape.ctrlsData.forEach(function(t){e.drawCtrls(t)})},h.prototype.drawRect=function(t){var e=u(t.coor,2),i=u(e[0],2),a=i[0],r=i[1],i=u(e[1],2),e=i[0],i=i[1];this.ctx.save(),this.ctx.fillStyle=this.fillStyle,this.ctx.strokeStyle=t.active||t.creating?this.activeStrokeStyle:this.strokeStyle,this.ctx.strokeRect(a,r,e-a,i-r),t.creating||this.ctx.fillRect(a,r,e-a,i-r),this.ctx.restore(),this.drawLabel(t.coor[0],t.label)},h.prototype.drawPolygon=function(t){var i=this;this.ctx.save(),this.ctx.fillStyle=this.fillStyle,this.ctx.strokeStyle=t.active||t.creating?this.activeStrokeStyle:this.strokeStyle,this.ctx.beginPath(),t.coor.forEach(function(t,e){0===e?i.ctx.moveTo(t[0],t[1]):i.ctx.lineTo(t[0],t[1])}),t.creating&&this.ctx.lineTo(this.movePoint[0],this.movePoint[1]),2<t.coor.length&&t.finish&&this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),this.ctx.restore(),this.drawLabel(t.coor[0],t.label)},h.prototype.drawCtrls=function(t){var e=u(t,2),t=e[0],e=e[1];this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle="#fff",this.ctx.arc(t,e,this.CTRL_R,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.arc(t,e,this.CTRL_R,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore()},h.prototype.drawLabel=function(t,e){var i;e.length&&(i=e.length<5?e:e.substr(0,4)+"...",e=this.ctx.measureText(i),this.ctx.save(),this.ctx.fillStyle="#fff",this.ctx.fillRect(t[0]+1,t[1]+1,e.width+4,16),this.ctx.font="12px serif #000",this.ctx.strokeText(i,t[0]+2,t[1]+12,80),this.ctx.restore())},h.prototype.deleteByIndex=function(e){var t=this.dataset.findIndex(function(t){return t.index===e});-1<t&&(this.emit("delete",this.dataset[t]),this.dataset.splice(t,1),this.dataset.forEach(function(t,e){t.index=e}),this.update())},h.prototype.on=function(t,e){var i=this.EventList[t];Array.isArray(i)?i.push(e):this.EventList[t]=[e]},h.prototype.emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];t=this.EventList[t];Array.isArray(t)&&t.forEach(function(t){return t.apply(void 0,function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(u(arguments[e]));return t}(e))})},h.prototype.off=function(t,e){var i=this.EventList[t],t=i.find(function(t){return t===e});Array.isArray(i)&&t&&i.splice(t,1)},h});
