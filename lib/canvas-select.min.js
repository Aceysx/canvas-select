!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).CanvasSelect=e()}(this,function(){"use strict";function H(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var a,s,r=i.call(t),n=[];try{for(;(void 0===e||0<e--)&&!(a=r.next()).done;)n.push(a.value)}catch(t){s={error:t}}finally{try{a&&!a.done&&(i=r.return)&&i.call(r)}finally{if(s)throw s.error}}return n}var h=(Object.defineProperty(t.prototype,"ctrlsData",{get:function(){var t=H(this.coor,2),e=H(t[0],2),i=e[0],a=e[1],e=H(t[1],2),t=e[0],e=e[1];return[[i,a],[i+(t-i)/2,a],[t,a],[t,a+(e-a)/2],[t,e],[i+(t-i)/2,e],[i,e],[i,a+(e-a)/2]]},enumerable:!1,configurable:!0}),t);function t(t,e){this.label="",this.type=1,this.active=!1,this.creating=!1,this.dragging=!1,this.coor=t,this.index=e}var c=(Object.defineProperty(e.prototype,"ctrlsData",{get:function(){return 2<this.coor.length?this.coor:[]},enumerable:!1,configurable:!0}),e);function e(t,e){this.label="",this.type=2,this.active=!1,this.creating=!1,this.dragging=!1,this.finish=!0,this.coor=t,this.index=e}function l(t,e){this.lock=!1,this.MIN_WIDTH=10,this.MIN_HEIGHT=10,this.strokeStyle="rgb(0, 0, 255)",this.fillStyle="rgba(0, 0, 255,0.1)",this.activeStrokeStyle="#f00",this.activeFillStyle="rgba(255, 0, 0,0.1)",this.ctrlStrokeStyle="#000",this.ctrlFillStyle="#fff",this.ctrlRadius=3,this.labelFillStyle="#fff",this.labelFont="12px serif #000",this.labelMaxLen=5,this.EventList={},this.dataset=[],this.remmberOrigin=[0,0],this.createType=0,this.ctrlIndex=-1,this.cursor="auto",this.image=new Image,this.originX=0,this.originY=0,this.scaleStep=0;t="string"==typeof t?document.querySelector(t):t;Object.prototype.toString.call(t).includes("HTMLCanvasElement")?(this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.WIDTH=this.canvas.clientWidth,this.HEIGHT=this.canvas.clientWidth,this.offlineCanvas=document.createElement("canvas"),this.offlineCanvas.width=this.WIDTH,this.offlineCanvas.height=this.HEIGHT,this.offlineCtx=this.offlineCanvas.getContext("2d"),this.init(),e&&(this.image.src=e)):console.warn("HTMLCanvasElement is required!")}return Object.defineProperty(l.prototype,"activeShape",{get:function(){return this.dataset.find(function(t){return t.active})},enumerable:!1,configurable:!0}),Object.defineProperty(l.prototype,"createShape",{get:function(){return this.dataset.find(function(t){return t.creating})},enumerable:!1,configurable:!0}),Object.defineProperty(l.prototype,"scale",{get:function(){return this.IMAGE_ORIGIN_WIDTH&&this.IMAGE_WIDTH?this.IMAGE_WIDTH/this.IMAGE_ORIGIN_WIDTH:1},enumerable:!1,configurable:!0}),l.createUuid=function(){for(var t=[],e="0123456789abcdef",i=0;i<36;i++)t[i]=e.substr(Math.floor(16*Math.random()),1);return t[14]="4",t[19]=e.substr(3&t[19]|8,1),t[8]=t[13]=t[18]=t[23]="-",t.join("")},l.prototype.init=function(){var g=this;this.canvas.style.userSelect="none",this.image.addEventListener("load",function(){g.IMAGE_ORIGIN_WIDTH=g.IMAGE_WIDTH=g.image.width,g.IMAGE_ORIGIN_HEIGHT=g.IMAGE_HEIGHT=g.image.height,g.fitZoom(),g.emit("load")}),this.canvas.addEventListener("contextmenu",function(t){g.lock||t.preventDefault()}),this.canvas.addEventListener("mousedown",function(e){var i,a,s,t,r,n,o;g.lock||(i=e.offsetX/g.scale,a=e.offsetY/g.scale,2===e.buttons?g.remmberOrigin=[e.offsetX-g.originX,e.offsetY-g.originY]:1===e.buttons&&(g.dataset.reverse(),s=g.dataset.find(function(t){return g.isPointInArea([e.offsetX,e.offsetY],t)}),g.dataset.reverse(),t=g.activeShape?g.activeShape.ctrlsData:[],g.ctrlIndex=t.findIndex(function(t){return g.isPointInCtrl([e.offsetX,e.offsetY],t)}),-1<g.ctrlIndex?(t=(r=H(g.activeShape.ctrlsData[g.ctrlIndex],2))[0],r=r[1],g.remmber=[[i-t,a-r]]):g.createShape&&2===g.createShape.type&&!g.createShape.finish&&g.isInBox(e)?(r=(o=H(g.createShape.coor[g.createShape.coor.length-1],2))[0],o=o[1],r!==i&&o!==a&&g.createShape.coor.push([i-g.originX/g.scale,a-g.originY/g.scale])):s?(n=g.dataset.findIndex(function(t){return t===s}),g.emit("select",s),g.dataset.forEach(function(t){t.active=!1}),s.active=!0,s.dragging=!0,g.dataset.splice(n,1),g.dataset.push(s),g.remmber=[],s.coor.forEach(function(t){g.remmber.push([i-t[0],a-t[1]])}),g.update()):g.createType&&g.isInBox(e)&&(o=void 0,1===g.createType?(n=[i-g.originX/g.scale,a-g.originY/g.scale],o=new h([n,n],g.dataset.length)):2===g.createType&&((o=new c([[i-g.originX/g.scale,a-g.originY/g.scale]],g.dataset.length)).finish=!1),g.dataset.forEach(function(t){t.active=!1}),o.creating=!0,o.uuid=l.createUuid(),g.dataset.push(o))))}),this.canvas.addEventListener("mousemove",function(e){if(!g.lock){var t=e.offsetX/g.scale,i=e.offsetY/g.scale;if(1!==e.buttons&&(h=(g.activeShape?g.activeShape.ctrlsData:[]).find(function(t){return g.isPointInCtrl([e.offsetX,e.offsetY],t)}),o=g.dataset.find(function(t){return g.isPointInArea([e.offsetX,e.offsetY],t)}),g.canvas.style.cursor=o&&!h?"move":"auto"),g.movePoint=[t,i],2===e.buttons&&3===e.which)g.originX=e.offsetX-g.remmberOrigin[0],g.originY=e.offsetY-g.remmberOrigin[1],g.update();else if(1===e.buttons&&g.isInBox(e)){if(-1<g.ctrlIndex){g.emit("resize",g.activeShape);var a=H(g.remmber,1),s=H(a[0],2),r=s[0],n=s[1];if(1===g.activeShape.type){var o=H(g.activeShape.coor,2),h=H(o[0],2),c=h[0],l=h[1],a=H(o[1],2),f=a[0],p=a[1],u=[];switch(g.ctrlIndex){case 0:u=[[t-r,i-n],[f,p]];break;case 1:u=[[c,i-n],[f,p]];break;case 2:u=[[c,i-n],[t-r,p]];break;case 3:u=[[c,l],[t-r,p]];break;case 4:u=[[c,l],[t-r,i-n]];break;case 5:u=[[c,l],[f,i-n]];break;case 6:u=[[t-r,l],[f,i-n]];break;case 7:u=[[t-r,l],[f,p]]}s=H(u,2),h=H(s[0],2),o=h[0],a=h[1],h=H(s[1],2),s=h[0],h=h[1];s-o>=g.MIN_WIDTH&&h-a>=g.MIN_HEIGHT?g.activeShape.coor=u:g.emit("error","宽不能小于"+g.MIN_WIDTH+",高不能小于"+g.MIN_HEIGHT+"。")}else 2===g.activeShape.type&&g.activeShape.coor.splice(g.ctrlIndex,1,[t-g.originX/g.scale,i-g.originY/g.scale])}else if(g.activeShape&&g.activeShape.dragging&&g.activeShape.coor.length===g.remmber.length){for(var u=[],I=0;I<g.activeShape.coor.length;I++){var d=g.remmber[I],r=t-d[0],n=i-d[1],v=g.IMAGE_ORIGIN_WIDTH||g.WIDTH,d=g.IMAGE_ORIGIN_HEIGHT||g.HEIGHT;if(r<0||v<r||n<0||d<n)return;u.push([r,n])}g.activeShape.coor=u}else g.createShape&&1===g.createShape.type&&g.createShape.coor.splice(1,1,[t-g.originX/g.scale,i-g.originY/g.scale]);g.update()}else g.createShape&&2===g.createShape.type&&g.update()}}),this.canvas.addEventListener("mouseup",function(){var t,e,i,a;g.lock||(g.remmber=[],g.createShape&&1===g.createShape.type&&(i=H(g.createShape.coor,2),t=(a=H(i[0],2))[0],e=a[1],i=(a=H(i[1],2))[0],a=a[1],Math.abs(t-i)<g.MIN_WIDTH||Math.abs(e-a)<g.MIN_HEIGHT?(g.dataset.pop(),g.emit("error","宽不能小于"+g.MIN_WIDTH+",高不能小于"+g.MIN_HEIGHT)):(g.createShape.coor=[[Math.min(t,i),Math.min(e,a)],[Math.max(t,i),Math.max(e,a)]],g.emit("add",g.createShape)),g.dataset.forEach(function(t){t.creating=!1}),g.update(),g.emit("update")))}),this.canvas.addEventListener("dblclick",function(){g.lock||g.createShape&&2===g.createShape.type&&2<g.createShape.coor.length&&(g.emit("add",g.createShape),g.createShape.finish=!0,g.createShape.creating=!1,g.update())}),document.body.addEventListener("keyup",function(t){g.lock||(g.createShape&&2===g.createShape.type&&("Escape"===t.key?g.dataset.pop():"Backspace"===t.key&&(1<g.createShape.coor.length?g.createShape.coor:g.dataset).pop(),g.update()),g.activeShape&&"Backspace"===t.key&&g.deleteByIndex(g.activeShape.index))}),this.canvas.addEventListener("mousewheel",function(t){g.lock||(t.preventDefault(),g.setScale(t.deltaY<0))})},l.prototype.setData=function(t){var o=this;t.forEach(function(t,e){var i,a,s,r,n;-1<Object.prototype.toString.call(t).indexOf("Object")?(i=t.label,a=t.type,s=t.coor,r=t.uuid,n=void 0,"number"==typeof a&&0<a?(1===a&&2===s.length&&(n=new h(s,e)),(n=2===a&&2<s.length?new c(s,e):n).label=(i||"").toString(),n.uuid=r||l.createUuid(),o.dataset.push(n)):o.emit("error","type is invalidated.")):o.emit("error",t+" in data must be an enumerable Object.")}),this.update()},l.prototype.calcStep=function(t){t&&(this.scaleStep=100,this.setScale(!1)),(this.IMAGE_WIDTH>this.WIDTH||this.IMAGE_HEIGHT>this.HEIGHT)&&(this.setScale(!1),this.calcStep())},l.prototype.setScale=function(t){var e;this.lock||!t&&this.IMAGE_WIDTH<=20||t&&this.IMAGE_WIDTH>=100*this.WIDTH||(t?this.scaleStep++:this.scaleStep--,e=Math.abs(this.scaleStep),t=this.IMAGE_WIDTH,this.IMAGE_WIDTH=Math.round(this.IMAGE_ORIGIN_WIDTH*Math.pow(0<=this.scaleStep?1.05:.95,e)),this.IMAGE_HEIGHT=Math.round(this.IMAGE_ORIGIN_HEIGHT*Math.pow(0<=this.scaleStep?1.05:.95,e)),this.stayPosition(this.IMAGE_WIDTH/t),this.update())},l.prototype.fitZoom=function(){this.calcStep(!0),this.IMAGE_HEIGHT/this.IMAGE_WIDTH>=this.HEIGHT/this.WIDTH?(this.IMAGE_WIDTH=this.IMAGE_ORIGIN_WIDTH/(this.IMAGE_ORIGIN_HEIGHT/this.HEIGHT),this.IMAGE_HEIGHT=this.HEIGHT):(this.IMAGE_WIDTH=this.WIDTH,this.IMAGE_HEIGHT=this.IMAGE_ORIGIN_HEIGHT/(this.IMAGE_ORIGIN_WIDTH/this.WIDTH)),this.originX=(this.WIDTH-this.IMAGE_WIDTH)/2,this.originY=(this.HEIGHT-this.IMAGE_HEIGHT)/2,this.update()},l.prototype.stayPosition=function(t){this.originX=this.WIDTH/2-(this.WIDTH/2-this.originX)*t,this.originY=this.HEIGHT/2-(this.HEIGHT/2-this.originY)*t},l.prototype.isInBox=function(t){var e=t.offsetX/this.scale,t=t.offsetY/this.scale;return e>=this.originX/this.scale&&t>=this.originY/this.scale&&e<=this.originX/this.scale+this.IMAGE_ORIGIN_WIDTH&&t<=this.originY/this.scale+this.IMAGE_ORIGIN_HEIGHT},l.prototype.isPointInArea=function(t,e){var i,a,s,r,n,o,h=this;this.offlineCtx.save(),this.offlineCtx.clearRect(0,0,this.WIDTH,this.HEIGHT),this.offlineCtx.translate(this.originX,this.originY),1===e.type?(s=H(e.coor,2),n=(a=H(s[0],2))[0],o=a[1],i=(r=H(s[1],2))[0],a=r[1],s=Math.round(n*this.scale),r=Math.round(o*this.scale),n=Math.round((i-n)*this.scale),o=Math.round((a-o)*this.scale),this.offlineCtx.fillRect(s,r,n,o)):2===e.type&&(this.offlineCtx.beginPath(),e.coor.forEach(function(t,e){var i=Math.round(t[0]*h.scale),t=Math.round(t[1]*h.scale);0===e?h.offlineCtx.moveTo(i,t):h.offlineCtx.lineTo(i,t)}),this.offlineCtx.closePath(),this.offlineCtx.fill());e=this.offlineCtx.getImageData(0,0,this.WIDTH,this.HEIGHT),t=(t[1]-1)*this.WIDTH*4+4*t[0];return this.offlineCtx.restore(),0!==e.data[3+t]},l.prototype.isPointInCtrl=function(t,e){this.offlineCtx.save();var i=H(e,2),e=i[0],i=i[1],e=Math.round(e*this.scale),i=Math.round(i*this.scale);this.offlineCtx.clearRect(0,0,this.WIDTH,this.HEIGHT),this.offlineCtx.translate(this.originX,this.originY),this.offlineCtx.beginPath(),this.offlineCtx.arc(e,i,this.ctrlRadius,0,2*Math.PI),this.offlineCtx.fill();i=this.offlineCtx.getImageData(0,0,this.WIDTH,this.HEIGHT),t=(t[1]-1)*this.WIDTH*4+4*t[0];return this.offlineCtx.restore(),0!==i.data[3+t]},l.prototype.drawRect=function(t){var e=H(t.coor,2),i=H(e[0],2),a=i[0],s=i[1],r=H(e[1],2),n=r[0],i=r[1];this.ctx.save(),this.ctx.fillStyle=this.fillStyle,this.ctx.strokeStyle=t.active||t.creating?this.activeStrokeStyle:this.strokeStyle;e=Math.round(a*this.scale),r=Math.round(s*this.scale),a=Math.round((n-a)*this.scale),s=Math.round((i-s)*this.scale);this.ctx.strokeRect(e,r,a,s),t.creating||this.ctx.fillRect(e,r,a,s),this.ctx.restore(),this.drawLabel(t.coor[0],t.label)},l.prototype.drawPolygon=function(t){var e,i,a=this;this.ctx.save(),this.ctx.fillStyle=this.fillStyle,this.ctx.strokeStyle=t.active||t.creating?this.activeStrokeStyle:this.strokeStyle,this.ctx.beginPath(),t.coor.forEach(function(t,e){var i=Math.round(t[0]*a.scale),t=Math.round(t[1]*a.scale);0===e?a.ctx.moveTo(i,t):a.ctx.lineTo(i,t)}),t.creating&&(e=Math.round(this.movePoint[0]*this.scale),i=Math.round(this.movePoint[1]*this.scale),this.ctx.lineTo(e-this.originX,i-this.originY)),2<t.coor.length&&t.finish&&this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),this.ctx.restore(),this.drawLabel(t.coor[0],t.label)},l.prototype.paintImage=function(){this.ctx.drawImage(this.image,0,0,this.IMAGE_WIDTH,this.IMAGE_HEIGHT)},l.prototype.drawCtrls=function(t){var e=H(t,2),t=e[0],e=e[1],t=Math.round(t*this.scale),e=Math.round(e*this.scale);this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle=this.ctrlFillStyle,this.ctx.arc(t,e,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.strokeStyle=this.ctrlStrokeStyle,this.ctx.arc(t,e,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore()},l.prototype.drawLabel=function(t,e){var i,a;e.length&&(i=e.length<this.labelMaxLen+1?e:e.substr(0,this.labelMaxLen)+"...",a=this.ctx.measureText(i),e=Math.round(t[0]*this.scale),t=Math.round(t[1]*this.scale),this.ctx.save(),this.ctx.fillStyle=this.labelFillStyle,this.ctx.fillRect(e+1,t+1,a.width+4,16),this.ctx.font=this.labelFont,this.ctx.strokeText(i,e+2,t+12,80),this.ctx.restore())},l.prototype.clear=function(){this.ctx.clearRect(0,0,this.WIDTH,this.HEIGHT)},l.prototype.update=function(){var e=this;this.ctx.save(),this.clear(),this.ctx.translate(this.originX,this.originY),this.paintImage(),this.dataset.forEach(function(t){1===t.type?e.drawRect(t):2===t.type&&e.drawPolygon(t)}),this.activeShape&&this.activeShape.ctrlsData.forEach(function(t){e.drawCtrls(t)}),this.ctx.restore()},l.prototype.deleteByIndex=function(e){var t=this.dataset.findIndex(function(t){return t.index===e});-1<t&&(this.emit("delete",this.dataset[t]),this.dataset.splice(t,1),this.dataset.forEach(function(t,e){t.index=e}),this.update())},l.prototype.on=function(t,e){var i=this.EventList[t];Array.isArray(i)?i.push(e):this.EventList[t]=[e]},l.prototype.emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];t=this.EventList[t];Array.isArray(t)&&t.forEach(function(t){return t.apply(void 0,function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(H(arguments[e]));return t}(e))})},l.prototype.off=function(t,e){var i=this.EventList[t],t=i.find(function(t){return t===e});Array.isArray(i)&&t&&i.splice(t,1)},l});
