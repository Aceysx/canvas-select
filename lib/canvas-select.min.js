!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).CanvasSelect=e()}(this,function(){"use strict";function d(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var a,r,s=i.call(t),o=[];try{for(;(void 0===e||0<e--)&&!(a=s.next()).done;)o.push(a.value)}catch(t){r={error:t}}finally{try{a&&!a.done&&(i=s.return)&&i.call(s)}finally{if(r)throw r.error}}return o}var n=(Object.defineProperty(t.prototype,"ctrlsData",{get:function(){var t=d(this.coor,2),e=d(t[0],2),i=e[0],a=e[1],e=d(t[1],2),t=e[0],e=e[1];return[[i,a],[i+(t-i)/2,a],[t,a],[t,a+(e-a)/2],[t,e],[i+(t-i)/2,e],[i,e],[i,a+(e-a)/2]]},enumerable:!1,configurable:!0}),t);function t(t,e){this.label="",this.type=1,this.active=!1,this.creating=!1,this.dragging=!1,this.coor=t,this.index=e}var c=(Object.defineProperty(e.prototype,"ctrlsData",{get:function(){return 2<this.coor.length?this.coor:[]},enumerable:!1,configurable:!0}),e);function e(t,e){this.label="",this.type=2,this.active=!1,this.creating=!1,this.dragging=!1,this.finish=!0,this.coor=t,this.index=e}function f(t){this.MIN_WIDTH=10,this.MIN_HEIGHT=10,this.CTRL_R=5,this.activeStrokeStyle="#f00",this.activeFillStyle="rgba(255, 0, 0,0.1)",this.strokeStyle="rgba(0, 0, 255)",this.fillStyle="rgba(0, 0, 255,0.1)",this.EventList=[],this.dataset=[],this.createType=0,this.ctrlIndex=-1;t="string"==typeof t?document.querySelector(t):t;Object.prototype.toString.call(t).includes("HTMLCanvasElement")?(this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.WIDTH=this.canvas.clientWidth,this.HEIGHT=this.canvas.clientWidth,this.offlineCanvas=document.createElement("canvas"),this.offlineCanvas.width=this.WIDTH,this.offlineCanvas.height=this.HEIGHT,this.offlineCtx=this.offlineCanvas.getContext("2d"),this.init()):this.emit("error","HTMLCanvasElement is required!")}return f.prototype.setData=function(t){var o=this;t.forEach(function(t,e){var i,a=t.label,r=t.type,s=t.coor,t=t.uuid;"number"==typeof r&&0<r?(1===r&&2===s.length&&(i=new n(s,e)),(i=2===r&&2<s.length?new c(s,e):i).label=(a||"").toString(),i.uuid=t||f.createUuid(),o.dataset.push(i)):o.emit("error","type is invalidated")}),this.update()},Object.defineProperty(f.prototype,"activeShape",{get:function(){return this.dataset.find(function(t){return t.active})},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"createShape",{get:function(){return this.dataset.find(function(t){return t.creating})},enumerable:!1,configurable:!0}),f.createUuid=function(){for(var t=[],e="0123456789abcdef",i=0;i<36;i++)t[i]=e.substr(Math.floor(16*Math.random()),1);return t[14]="4",t[19]=e.substr(3&t[19]|8,1),t[8]=t[13]=t[18]=t[23]="-",t.join("")},f.prototype.init=function(){var u=this;this.canvas.style.userSelect="none",this.canvas.addEventListener("mousedown",function(e){if(u.activeShape){var t=u.activeShape.ctrlsData;if(u.ctrlIndex=t.findIndex(function(t){return u.isPointInCtrl([e.offsetX,e.offsetY],t)}),-1<u.ctrlIndex){var i=d(t[u.ctrlIndex],2),a=i[0],i=i[1];return void(u.remmber=[[e.offsetX-a,e.offsetY-i]])}}u.dataset.reverse();var r,s=u.dataset.find(function(t){return u.isPointInArea([e.offsetX,e.offsetY],t)});u.dataset.reverse(),u.dataset.forEach(function(t){t.active=!1}),u.createShape?2===u.createShape.type&&(u.createShape.finish||(i=(a=d(u.createShape.coor[u.createShape.coor.length-1],2))[0],a=a[1],i!==e.offsetX&&a!==e.offsetY&&u.createShape.coor.push([e.offsetX,e.offsetY]))):s?(u.emit("select",s),s.active=!0,s.dragging=!0,r=u.dataset.findIndex(function(t){return t===s}),u.dataset.splice(r,1),u.dataset.push(s),u.remmber=[],s.coor.forEach(function(t){u.remmber.push([e.offsetX-t[0],e.offsetY-t[1]])})):u.createType&&(r=void 0,1===u.createType?r=new n([[e.offsetX,e.offsetY],[e.offsetX,e.offsetY]],u.dataset.length):2===u.createType&&((r=new c([[e.offsetX,e.offsetY]],u.dataset.length)).finish=!1),r.creating=!0,r.uuid=f.createUuid(),u.dataset.push(r)),u.update()}),this.canvas.addEventListener("mousemove",function(e){var t=u.dataset.find(function(t){return u.isPointInArea([e.offsetX,e.offsetY],t)});if(u.canvas.style.cursor=t?"move":"auto",1===e.buttons)if(-1<u.ctrlIndex){u.emit("resize",u.activeShape);var i=d(u.remmber,1),a=d(i[0],2),r=a[0],s=a[1];if(1===u.activeShape.type){var o=d(u.activeShape.coor,2),t=d(o[0],2),n=t[0],c=t[1],i=d(o[1],2),f=i[0],h=i[1],l=[];switch(u.ctrlIndex){case 0:l=[[e.offsetX-r,e.offsetY-s],[f,h]];break;case 1:l=[[n,e.offsetY-s],[f,h]];break;case 2:l=[[n,e.offsetY-s],[e.offsetX-r,h]];break;case 3:l=[[n,c],[e.offsetX-r,h]];break;case 4:l=[[n,c],[e.offsetX-r,e.offsetY-s]];break;case 5:l=[[n,c],[f,e.offsetY-s]];break;case 6:l=[[e.offsetX-r,c],[f,e.offsetY-s]];break;case 7:l=[[e.offsetX-r,c],[f,h]]}a=d(l,2),t=d(a[0],2),o=t[0],i=t[1],t=d(a[1],2),a=t[0],t=t[1];a-o>=u.MIN_WIDTH&&t-i>=u.MIN_HEIGHT?u.activeShape.coor=l:u.emit("error","宽不能小于"+u.MIN_WIDTH+",高不能小于"+u.MIN_HEIGHT)}else 2===u.activeShape.type&&u.activeShape.coor.splice(u.ctrlIndex,1,[e.offsetX,e.offsetY])}else if(u.activeShape&&u.activeShape.dragging){for(var l=[],p=0;p<u.activeShape.coor.length;p++){r=e.offsetX-u.remmber[p][0],s=e.offsetY-u.remmber[p][1];if(r<0||r>u.WIDTH||s<0||s>u.HEIGHT)return;l.push([r,s])}u.activeShape.coor=l}else u.createShape&&1===u.createShape.type&&u.createShape.coor.splice(1,1,[e.offsetX,e.offsetY]);u.movePoint=[e.offsetX,e.offsetY],u.update()}),this.canvas.addEventListener("mouseup",function(){var t,e,i,a;u.createShape&&1===u.createShape.type&&(i=d(u.createShape.coor,2),t=(a=d(i[0],2))[0],e=a[1],i=(a=d(i[1],2))[0],a=a[1],Math.abs(t-i)<u.MIN_WIDTH||Math.abs(e-a)<u.MIN_HEIGHT?(u.dataset.pop(),u.emit("error","宽不能小于"+u.MIN_WIDTH+",高不能小于"+u.MIN_HEIGHT)):(u.createShape.coor=[[Math.min(t,i),Math.min(e,a)],[Math.max(t,i),Math.max(e,a)]],u.emit("add",u.createShape)),u.dataset.forEach(function(t){t.creating=!1})),u.update(),u.emit("update")}),this.canvas.addEventListener("dblclick",function(){u.createShape&&2===u.createShape.type&&2<u.createShape.coor.length&&(u.emit("add",u.createShape),u.createShape.finish=!0,u.createShape.creating=!1,u.update())}),document.body.addEventListener("keyup",function(t){u.createShape&&2===u.createShape.type&&("Escape"===t.key?u.dataset.pop():"Backspace"===t.key&&(1<u.createShape.coor.length?u.createShape.coor:u.dataset).pop(),u.update())})},f.prototype.isPointInArea=function(t,e){var i,a,r,s,o=this;this.offlineCtx.clearRect(0,0,this.WIDTH,this.HEIGHT),1===e.type?(r=d(e.coor,2),i=(s=d(r[0],2))[0],a=s[1],r=(s=d(r[1],2))[0],s=s[1],this.offlineCtx.fillRect(i,a,r-i,s-a)):2===e.type&&(this.offlineCtx.beginPath(),e.coor.forEach(function(t,e){0===e?o.offlineCtx.moveTo(t[0],t[1]):o.offlineCtx.lineTo(t[0],t[1])}),this.offlineCtx.closePath(),this.offlineCtx.fill());e=this.offlineCtx.getImageData(0,0,this.WIDTH,this.HEIGHT),t=(t[1]-1)*this.WIDTH*4+4*t[0];return 0!==e.data[3+t]},f.prototype.isPointInCtrl=function(t,e){var i=d(e,2),e=i[0],i=i[1];this.offlineCtx.clearRect(0,0,this.WIDTH,this.HEIGHT),this.offlineCtx.beginPath(),this.offlineCtx.arc(e,i,this.CTRL_R,0,2*Math.PI),this.offlineCtx.fill();i=this.offlineCtx.getImageData(0,0,this.WIDTH,this.HEIGHT),t=(t[1]-1)*this.WIDTH*4+4*t[0];return 0!==i.data[3+t]},f.prototype.clear=function(){this.ctx.clearRect(0,0,this.WIDTH,this.HEIGHT)},f.prototype.update=function(){var e=this;this.clear(),this.dataset.forEach(function(t){1===t.type?e.drawRect(t):2===t.type&&e.drawPolygon(t)}),this.activeShape&&this.activeShape.ctrlsData.forEach(function(t){e.drawCtrls(t)})},f.prototype.drawRect=function(t){var e=d(t.coor,2),i=d(e[0],2),a=i[0],r=i[1],i=d(e[1],2),e=i[0],i=i[1];this.ctx.save(),this.ctx.fillStyle=this.fillStyle,this.ctx.strokeStyle=t.active||t.creating?this.activeStrokeStyle:this.strokeStyle,this.ctx.strokeRect(a,r,e-a,i-r),t.creating||this.ctx.fillRect(a,r,e-a,i-r),this.ctx.restore(),this.drawLabel(t.coor[0],t.label)},f.prototype.drawPolygon=function(t){var i=this;this.ctx.save(),this.ctx.fillStyle=this.fillStyle,this.ctx.strokeStyle=t.active||t.creating?this.activeStrokeStyle:this.strokeStyle,this.ctx.beginPath(),t.coor.forEach(function(t,e){0===e?i.ctx.moveTo(t[0],t[1]):i.ctx.lineTo(t[0],t[1])}),t.creating&&this.ctx.lineTo(this.movePoint[0],this.movePoint[1]),2<t.coor.length&&t.finish&&this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),this.ctx.restore(),this.drawLabel(t.coor[0],t.label)},f.prototype.drawCtrls=function(t){var e=d(t,2),t=e[0],e=e[1];this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle="#fff",this.ctx.arc(t,e,this.CTRL_R,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.arc(t,e,this.CTRL_R,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore()},f.prototype.drawLabel=function(t,e){var i;e.length&&(i=e.length<5?e:e.substr(0,4)+"...",e=this.ctx.measureText(i),this.ctx.save(),this.ctx.fillStyle="#fff",this.ctx.fillRect(t[0]+1,t[1]+1,e.width+4,16),this.ctx.font="12px serif #000",this.ctx.strokeText(i,t[0]+2,t[1]+12,80),this.ctx.restore())},f.prototype.deleteByIndex=function(e){var t=this.dataset.findIndex(function(t){return t.index===e});-1<t&&(this.emit("delete",this.dataset[t]),this.dataset.splice(t,1),this.dataset.forEach(function(t,e){t.index=e}),this.update())},f.prototype.on=function(t,e){var i=this.EventList[t];Array.isArray(i)?i.push(e):this.EventList[t]=[e]},f.prototype.emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];t=this.EventList[t];Array.isArray(t)&&t.forEach(function(t){return t.apply(void 0,function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(d(arguments[e]));return t}(e))})},f.prototype.off=function(t,e){var i=this.EventList[t],t=i.find(function(t){return t===e});Array.isArray(i)&&t&&i.splice(t,1)},f});
