!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).CanvasSelect=e()}(this,function(){"use strict";function S(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var a,s,r=i.call(t),n=[];try{for(;(void 0===e||0<e--)&&!(a=r.next()).done;)n.push(a.value)}catch(t){s={error:t}}finally{try{a&&!a.done&&(i=r.return)&&i.call(r)}finally{if(s)throw s.error}}return n}var p=(Object.defineProperty(t.prototype,"ctrlsData",{get:function(){var t=S(this.coor,2),e=S(t[0],2),i=e[0],a=e[1],e=S(t[1],2),t=e[0],e=e[1];return[[i,a],[i+(t-i)/2,a],[t,a],[t,a+(e-a)/2],[t,e],[i+(t-i)/2,e],[i,e],[i,a+(e-a)/2]]},enumerable:!1,configurable:!0}),t);function t(t,e){this.label="",this.type=1,this.active=!1,this.creating=!1,this.dragging=!1,this.coor=t,this.index=e}var f=(Object.defineProperty(e.prototype,"ctrlsData",{get:function(){return 2<this.coor.length?this.coor:[]},enumerable:!1,configurable:!0}),e);function e(t,e){this.label="",this.type=2,this.active=!1,this.creating=!1,this.dragging=!1,this.coor=t,this.index=e}var u=function(t,e){this.label="",this.type=3,this.active=!1,this.dragging=!1,this.coor=t,this.index=e};function I(t,e){this.lock=!1,this.MIN_WIDTH=10,this.MIN_HEIGHT=10,this.strokeStyle="rgb(0, 0, 255)",this.fillStyle="rgba(0, 0, 255,0.1)",this.activeStrokeStyle="#f00",this.activeFillStyle="rgba(255, 0, 0,0.1)",this.ctrlStrokeStyle="#000",this.ctrlFillStyle="#fff",this.ctrlRadius=3,this.labelFillStyle="#fff",this.labelFont="12px serif #000",this.labelMaxLen=5,this.EventList={},this.dataset=[],this.remmberOrigin=[0,0],this.createType=0,this.ctrlIndex=-1,this.cursor="auto",this.image=new Image,this.originX=0,this.originY=0,this.scaleStep=0;t="string"==typeof t?document.querySelector(t):t;Object.prototype.toString.call(t).includes("HTMLCanvasElement")?(this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.WIDTH=this.canvas.clientWidth,this.HEIGHT=this.canvas.clientHeight,this.offlineCanvas=document.createElement("canvas"),this.offlineCanvas.width=this.WIDTH,this.offlineCanvas.height=this.HEIGHT,this.offlineCtx=this.offlineCanvas.getContext("2d"),this.init(),e&&(this.image.src=e)):console.warn("HTMLCanvasElement is required!")}return Object.defineProperty(I.prototype,"activeShape",{get:function(){return this.dataset.find(function(t){return t.active})},enumerable:!1,configurable:!0}),Object.defineProperty(I.prototype,"scale",{get:function(){return this.IMAGE_ORIGIN_WIDTH&&this.IMAGE_WIDTH?this.IMAGE_WIDTH/this.IMAGE_ORIGIN_WIDTH:1},enumerable:!1,configurable:!0}),I.prototype.init=function(){var H=this;this.canvas.style.userSelect="none",this.image.addEventListener("load",function(){H.IMAGE_ORIGIN_WIDTH=H.IMAGE_WIDTH=H.image.width,H.IMAGE_ORIGIN_HEIGHT=H.IMAGE_HEIGHT=H.image.height,H.fitZoom(),H.emit("load")}),this.canvas.addEventListener("contextmenu",function(t){H.lock||t.preventDefault()}),this.canvas.addEventListener("mousewheel",function(t){H.lock||(t.preventDefault(),H.setScale(t.deltaY<0))}),this.canvas.addEventListener("mousedown",function(t){var e,i,a,s,r,n,o,c=t.offsetX/H.scale,h=t.offsetY/H.scale,l=[t.offsetX,t.offsetY];H.lock||(2===t.buttons?H.remmberOrigin=[t.offsetX-H.originX,t.offsetY-H.originY]:1===t.buttons&&(e=(null==(e=H.activeShape)?void 0:e.ctrlsData)||[],H.ctrlIndex=e.findIndex(function(t){return H.isPointInCircle(l,t,H.ctrlRadius)}),-1<H.ctrlIndex?(s=(a=S(e[H.ctrlIndex],2))[0],a=a[1],H.remmber=[[c-s,h-a]]):(s=S(H.hoverOnShape(l),2),i=s[0],a=s[1],!(s=2===(null===(s=H.activeShape)||void 0===s?void 0:s.type)&&H.activeShape.creating)&&-1<i?(H.emit("select",a),H.dataset.forEach(function(t,e){t.active=e===i}),a.dragging=!0,H.dataset.splice(i,1),H.dataset.push(a),H.remmber=[],3===a.type?(r=(n=S(a.coor,2))[0],n=n[1],H.remmber=[[c-r,h-n]]):a.coor.forEach(function(t){H.remmber.push([c-t[0],h-t[1]])}),H.update()):s&&H.isInContent(t)?(r=(s=S((o=H.activeShape).coor[o.coor.length-1],2))[0],n=s[1],r!==c&&n!==h&&(o.coor.push([c-H.originX/H.scale,h-H.originY/H.scale]),H.update())):H.createType&&H.isInContent(t)?(o=void 0,t=[c-H.originX/H.scale,h-H.originY/H.scale],1===H.createType?(o=new p([t,t],H.dataset.length)).creating=!0:2===H.createType?(o=new f([t],H.dataset.length)).creating=!0:3===H.createType&&(o=new u(t,H.dataset.length),H.emit("add",o)),H.dataset.forEach(function(t){t.active=!1}),o.active=!0,o.uuid=I.createUuid(),H.dataset.push(o),H.update()):H.activeShape&&(H.activeShape.active=!1,H.update()))))}),this.canvas.addEventListener("mousemove",function(t){var e,i=t.offsetX/H.scale,a=t.offsetY/H.scale;if(!H.lock)if(H.movePoint=[i,a],2===t.buttons&&3===t.which)H.originX=t.offsetX-H.remmberOrigin[0],H.originY=t.offsetY-H.remmberOrigin[1],H.update();else if(1===t.buttons){if(H.activeShape)if(-1<H.ctrlIndex){var s=S(H.remmber,1),r=S(s[0],2),n=r[0],o=r[1];if(H.emit("resize",H.activeShape),1===H.activeShape.type){var s=S(H.activeShape.coor,2),c=S(s[0],2),h=c[0],l=c[1],p=S(s[1],2),f=p[0],u=p[1],I=[];switch(H.ctrlIndex){case 0:I=[[i-n,a-o],[f,u]];break;case 1:I=[[h,a-o],[f,u]];break;case 2:I=[[h,a-o],[i-n,u]];break;case 3:I=[[h,l],[i-n,u]];break;case 4:I=[[h,l],[i-n,a-o]];break;case 5:I=[[h,l],[f,a-o]];break;case 6:I=[[i-n,l],[f,a-o]];break;case 7:I=[[i-n,l],[f,u]]}r=S(I,2),c=S(r[0],2),s=c[0],p=c[1],c=S(r[1],2),r=c[0],c=c[1];r-s>=H.MIN_WIDTH&&c-p>=H.MIN_HEIGHT?H.activeShape.coor=I:H.emit("error","宽不能小于"+H.MIN_WIDTH+",高不能小于"+H.MIN_HEIGHT+"。")}else 2===H.activeShape.type&&H.activeShape.coor.splice(H.ctrlIndex,1,[i-H.originX/H.scale,a-H.originY/H.scale]);H.update()}else if(H.activeShape.dragging){var I=[],d=H.IMAGE_ORIGIN_WIDTH||H.WIDTH,v=H.IMAGE_ORIGIN_HEIGHT||H.HEIGHT;if(3===H.activeShape.type){var c=S(H.remmber[0],2),p=c[0],o=a-c[1];if((n=i-p)<0||d<n||o<0||v<o)return;I=[n,o]}else for(var g=0;g<H.activeShape.coor.length;g++){var y=H.remmber[g],n=i-y[0],o=a-y[1];if(n<0||d<n||o<0||v<o)return;I.push([n,o])}H.activeShape.coor=I,H.update()}else H.activeShape.creating&&1===H.activeShape.type&&H.isInContent(t)&&(n=i-H.originX/H.scale,o=a-H.originY/H.scale,H.activeShape.coor.splice(1,1,[n,o]));H.update()}else 2===(null===(t=H.activeShape)||void 0===t?void 0:t.type)&&null!==(e=H.activeShape)&&void 0!==e&&e.creating&&H.update()}),this.canvas.addEventListener("mouseup",function(){var t,e,i,a;H.lock||(H.remmber=[],H.activeShape&&(H.activeShape.dragging=!1,H.activeShape.creating&&1===H.activeShape.type&&(i=S(H.activeShape.coor,2),t=(a=S(i[0],2))[0],e=a[1],i=(a=S(i[1],2))[0],a=a[1],Math.abs(t-i)<H.MIN_WIDTH||Math.abs(e-a)<H.MIN_HEIGHT?(H.dataset.pop(),H.emit("error","宽不能小于"+H.MIN_WIDTH+",高不能小于"+H.MIN_HEIGHT)):(H.activeShape.coor=[[Math.min(t,i),Math.min(e,a)],[Math.max(t,i),Math.max(e,a)]],H.activeShape.creating=!1,H.emit("add",H.activeShape)),H.update())))}),this.canvas.addEventListener("dblclick",function(){var t;H.lock||2===(null===(t=H.activeShape)||void 0===t?void 0:t.type)&&2<H.activeShape.coor.length&&(H.emit("add",H.activeShape),H.activeShape.creating=!1,H.update())}),document.body.addEventListener("keyup",function(t){var e;H.lock||(2===(null==(e=H.activeShape)?void 0:e.type)&&("Escape"===t.key?H.dataset.pop():"Backspace"===t.key&&(1<H.activeShape.coor.length?H.activeShape.coor:H.dataset).pop(),H.update()),H.activeShape&&"Backspace"===t.key&&H.deleteByIndex(H.activeShape.index))})},I.createUuid=function(){for(var t=[],e="0123456789abcdef",i=0;i<36;i++)t[i]=e.substr(Math.floor(16*Math.random()),1);return t[14]="4",t[19]=e.substr(3&t[19]|8,1),t[8]=t[13]=t[18]=t[23]="-",t.join("")},I.prototype.setData=function(t){var o=this;t.forEach(function(t,e){if(-1<Object.prototype.toString.call(t).indexOf("Object")){var i=t.label,a=t.type,s=t.coor,r=t.uuid,n=void 0;switch(a){case 1:n=new p(s,e);break;case 2:n=new f(s,e);break;case 3:n=new u(s,e)}n.label=(i||"").toString(),n.uuid=r||I.createUuid(),o.dataset.push(n)}else o.emit("error",t+" in data must be an enumerable Object.")}),this.update()},I.prototype.hoverOnShape=function(a){var s=this,r=-1,t=this.dataset.reduceRight(function(t,e,i){return t||(3===e.type&&s.isPointInCircle(a,e.coor,3)||1===e.type&&s.isPointInRect(a,e.coor)||2===e.type&&s.isPointInPolygon(a,e.coor))&&(r=i,t=e),t},null);return[r,t]},I.prototype.isInContent=function(t){var e=t.offsetX/this.scale,t=t.offsetY/this.scale;return e>=this.originX/this.scale&&t>=this.originY/this.scale&&e<=this.originX/this.scale+this.IMAGE_ORIGIN_WIDTH&&t<=this.originY/this.scale+this.IMAGE_ORIGIN_HEIGHT},I.prototype.isPointInRect=function(t,e){var i=this,a=S(t,2),s=a[0],r=a[1],n=S(e.map(function(t){return t.map(function(t){return t*i.scale})}),2),t=S(n[0],2),a=t[0],e=t[1],t=S(n[1],2),n=t[0],t=t[1];return a+this.originX<=s&&s<=n+this.originX&&e+this.originY<=r&&r<=t+this.originY},I.prototype.isPointInPolygon=function(t,e){var a=this;this.offlineCtx.save(),this.offlineCtx.clearRect(0,0,this.WIDTH,this.HEIGHT),this.offlineCtx.translate(this.originX,this.originY),this.offlineCtx.beginPath(),e.forEach(function(t,e){var i=S(t.map(function(t){return Math.round(t*a.scale)}),2),t=i[0],i=i[1];0===e?a.offlineCtx.moveTo(t,i):a.offlineCtx.lineTo(t,i)}),this.offlineCtx.closePath(),this.offlineCtx.fill();e=this.offlineCtx.getImageData(0,0,this.WIDTH,this.HEIGHT),t=(t[1]-1)*this.WIDTH*4+4*t[0];return this.offlineCtx.restore(),0!==e.data[3+t]},I.prototype.isPointInCircle=function(t,e,i){var a=this,s=S(t,2),r=s[0],t=s[1],s=S(e.map(function(t){return t*a.scale}),2),e=s[0],s=s[1];return Math.sqrt(Math.pow(e+this.originX-r,2)+Math.pow(s+this.originY-t,2))<=i},I.prototype.drawRect=function(t){var e,i,a,s,r=this;2===t.coor.length&&(a=S(t.coor.map(function(t){return t.map(function(t){return Math.round(t*r.scale)})}),2),e=(s=S(a[0],2))[0],i=s[1],a=(s=S(a[1],2))[0],s=s[1],this.ctx.save(),this.ctx.fillStyle=this.fillStyle,this.ctx.strokeStyle=t.active||t.creating?this.activeStrokeStyle:this.strokeStyle,this.ctx.strokeRect(e,i,a=a-e,s=s-i),t.creating||this.ctx.fillRect(e,i,a,s),this.ctx.restore(),this.drawLabel(t.coor[0],t.label))},I.prototype.drawPolygon=function(t){var e,i,a=this;this.ctx.save(),this.ctx.fillStyle=this.fillStyle,this.ctx.strokeStyle=t.active||t.creating?this.activeStrokeStyle:this.strokeStyle,this.ctx.beginPath(),t.coor.forEach(function(t,e){var i=S(t.map(function(t){return Math.round(t*a.scale)}),2),t=i[0],i=i[1];0===e?a.ctx.moveTo(t,i):a.ctx.lineTo(t,i)}),t.creating?(e=(i=S(this.movePoint.map(function(t){return Math.round(t*a.scale)}),2))[0],i=i[1],this.ctx.lineTo(e-this.originX,i-this.originY)):2<t.coor.length&&this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),this.ctx.restore(),this.drawLabel(t.coor[0],t.label)},I.prototype.drawDot=function(t){var e=this,i=S(t.coor.map(function(t){return t*e.scale}),2),a=i[0],i=i[1];this.ctx.save(),this.ctx.fillStyle=this.ctrlFillStyle,this.ctx.strokeStyle=t.active?this.activeStrokeStyle:this.strokeStyle,this.ctx.beginPath(),this.ctx.arc(a,i,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.arc(a,i,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore(),this.drawLabel(t.coor,t.label)},I.prototype.drawCtrl=function(t){var e=this,i=S(t.map(function(t){return t*e.scale}),2),t=i[0],i=i[1];this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle=this.ctrlFillStyle,this.ctx.strokeStyle=this.ctrlStrokeStyle,this.ctx.arc(t,i,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.arc(t,i,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore()},I.prototype.drawCtrlList=function(t){var e=this;t.ctrlsData.forEach(function(t){e.drawCtrl(t)})},I.prototype.drawLabel=function(t,e){var i,a,s,r,n=this;(e=void 0===e?"":e).length&&(i=e.length<this.labelMaxLen+1?e:e.substr(0,this.labelMaxLen)+"...",a=this.ctx.measureText(i),s=(r=S(t.map(function(t){return t*n.scale}),2))[0],e=r[1],r=this.IMAGE_ORIGIN_WIDTH-t[0]<(a.width+4)/this.scale,t=this.IMAGE_ORIGIN_HEIGHT-t[1]<16/this.scale,this.ctx.save(),this.ctx.fillStyle=this.labelFillStyle,this.ctx.fillRect(r?s-a.width-3:s+1,t?e-15:e+1,a.width+4,16),this.ctx.font=this.labelFont,this.ctx.strokeText(i,r?s-a.width-2:s+2,t?e-4:e+12,80),this.ctx.restore())},I.prototype.paintImage=function(){this.ctx.drawImage(this.image,0,0,this.IMAGE_WIDTH,this.IMAGE_HEIGHT)},I.prototype.clear=function(){this.ctx.clearRect(0,0,this.WIDTH,this.HEIGHT)},I.prototype.update=function(){var e=this;this.ctx.save(),this.clear(),this.ctx.translate(this.originX,this.originY),this.paintImage(),this.dataset.forEach(function(t){switch(t.type){case 1:e.drawRect(t);break;case 2:e.drawPolygon(t);break;case 3:e.drawDot(t)}}),this.activeShape&&[1,2].includes(this.activeShape.type)&&this.drawCtrlList(this.activeShape),this.ctx.restore()},I.prototype.deleteByIndex=function(e){var t=this.dataset.findIndex(function(t){return t.index===e});-1<t&&(this.emit("delete",this.dataset[t]),this.dataset.splice(t,1),this.dataset.forEach(function(t,e){t.index=e}),this.update())},I.prototype.calcStep=function(t){t&&(this.scaleStep=100,this.setScale(!1)),(this.IMAGE_WIDTH>this.WIDTH||this.IMAGE_HEIGHT>this.HEIGHT)&&(this.setScale(!1),this.calcStep())},I.prototype.setScale=function(t){var e;this.lock||!t&&this.IMAGE_WIDTH<=20||t&&this.IMAGE_WIDTH>=100*this.WIDTH||(t?this.scaleStep++:this.scaleStep--,e=Math.abs(this.scaleStep),t=this.IMAGE_WIDTH,this.IMAGE_WIDTH=Math.round(this.IMAGE_ORIGIN_WIDTH*Math.pow(0<=this.scaleStep?1.05:.95,e)),this.IMAGE_HEIGHT=Math.round(this.IMAGE_ORIGIN_HEIGHT*Math.pow(0<=this.scaleStep?1.05:.95,e)),this.stayPosition(this.IMAGE_WIDTH/t),this.update())},I.prototype.fitZoom=function(){this.calcStep(!0),this.IMAGE_HEIGHT/this.IMAGE_WIDTH>=this.HEIGHT/this.WIDTH?(this.IMAGE_WIDTH=this.IMAGE_ORIGIN_WIDTH/(this.IMAGE_ORIGIN_HEIGHT/this.HEIGHT),this.IMAGE_HEIGHT=this.HEIGHT):(this.IMAGE_WIDTH=this.WIDTH,this.IMAGE_HEIGHT=this.IMAGE_ORIGIN_HEIGHT/(this.IMAGE_ORIGIN_WIDTH/this.WIDTH)),this.originX=(this.WIDTH-this.IMAGE_WIDTH)/2,this.originY=(this.HEIGHT-this.IMAGE_HEIGHT)/2,this.update()},I.prototype.stayPosition=function(t){this.originX=this.WIDTH/2-(this.WIDTH/2-this.originX)*t,this.originY=this.HEIGHT/2-(this.HEIGHT/2-this.originY)*t},I.prototype.on=function(t,e){var i=this.EventList[t];Array.isArray(i)?i.push(e):this.EventList[t]=[e]},I.prototype.emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];t=this.EventList[t];Array.isArray(t)&&t.forEach(function(t){return t.apply(void 0,function(t,e){for(var i=0,a=e.length,s=t.length;i<a;i++,s++)t[s]=e[i];return t}([],S(e)))})},I.prototype.off=function(t,e){var i=this.EventList[t],t=i.find(function(t){return t===e});Array.isArray(i)&&t&&i.splice(t,1)},I});
//# sourceMappingURL=canvas-select.min.js.map
