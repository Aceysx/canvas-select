!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).CanvasSelect=e()}(this,(function(){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function t(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var a,s,r=i.call(t),n=[];try{for(;(void 0===e||e-- >0)&&!(a=r.next()).done;)n.push(a.value)}catch(t){s={error:t}}finally{try{a&&!a.done&&(i=r.return)&&i.call(r)}finally{if(s)throw s.error}}return n}function e(t,e){for(var i=0,a=e.length,s=t.length;i<a;i++,s++)t[s]=e[i];return t}var i=function(){function e(t,e){this.label="",this.type=1,this.active=!1,this.creating=!1,this.dragging=!1,this.coor=t,this.index=e}return Object.defineProperty(e.prototype,"ctrlsData",{get:function(){var e=t(this.coor,2),i=t(e[0],2),a=i[0],s=i[1],r=t(e[1],2),n=r[0],o=r[1];return[[a,s],[a+(n-a)/2,s],[n,s],[n,s+(o-s)/2],[n,o],[a+(n-a)/2,o],[a,o],[a,s+(o-s)/2]]},enumerable:!1,configurable:!0}),e}(),a=function(){function t(t,e){this.label="",this.type=2,this.active=!1,this.creating=!1,this.dragging=!1,this.coor=t,this.index=e}return Object.defineProperty(t.prototype,"ctrlsData",{get:function(){return this.coor.length>2?this.coor:[]},enumerable:!1,configurable:!0}),t}(),s=function(t,e){this.label="",this.type=3,this.active=!1,this.dragging=!1,this.coor=t,this.index=e};return function(){function r(t,e){this.lock=!1,this.MIN_WIDTH=10,this.MIN_HEIGHT=10,this.strokeStyle="rgb(0, 0, 255)",this.fillStyle="rgba(0, 0, 255,0.1)",this.activeStrokeStyle="#f00",this.activeFillStyle="rgba(255, 0, 0,0.1)",this.ctrlStrokeStyle="#000",this.ctrlFillStyle="#fff",this.ctrlRadius=3,this.labelFillStyle="#fff",this.labelFont="12px serif #000",this.labelMaxLen=5,this.EventList={},this.dataset=[],this.remmberOrigin=[0,0],this.createType=0,this.ctrlIndex=-1,this.cursor="auto",this.image=new Image,this.originX=0,this.originY=0,this.scaleStep=0;var i="string"==typeof t?document.querySelector(t):t;Object.prototype.toString.call(i).includes("HTMLCanvasElement")?(this.canvas=i,this.ctx=this.canvas.getContext("2d"),this.WIDTH=this.canvas.clientWidth,this.HEIGHT=this.canvas.clientHeight,this.offlineCanvas=document.createElement("canvas"),this.offlineCanvas.width=this.WIDTH,this.offlineCanvas.height=this.HEIGHT,this.offlineCtx=this.offlineCanvas.getContext("2d"),this.init(),e&&(this.image.src=e)):console.warn("HTMLCanvasElement is required!")}return Object.defineProperty(r.prototype,"activeShape",{get:function(){return this.dataset.find((function(t){return t.active}))},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"scale",{get:function(){return this.IMAGE_ORIGIN_WIDTH&&this.IMAGE_WIDTH?this.IMAGE_WIDTH/this.IMAGE_ORIGIN_WIDTH:1},enumerable:!1,configurable:!0}),r.prototype.init=function(){var e=this;this.canvas.style.userSelect="none",this.image.addEventListener("load",(function(){e.IMAGE_ORIGIN_WIDTH=e.IMAGE_WIDTH=e.image.width,e.IMAGE_ORIGIN_HEIGHT=e.IMAGE_HEIGHT=e.image.height,e.fitZoom(),e.emit("load")})),this.canvas.addEventListener("contextmenu",(function(t){e.lock||t.preventDefault()})),this.canvas.addEventListener("mousewheel",(function(t){e.lock||(t.preventDefault(),e.setScale(t.deltaY<0))})),this.canvas.addEventListener("mousedown",(function(n){var o,c=n.offsetX/e.scale,h=n.offsetY/e.scale,l=[n.offsetX,n.offsetY];if(!e.lock)if(2===n.buttons)e.remmberOrigin=[n.offsetX-e.originX,n.offsetY-e.originY];else if(1===n.buttons){var f=e.activeShape,p=(null==f?void 0:f.ctrlsData)||[];if(e.ctrlIndex=p.findIndex((function(t){return e.isPointInCircle(l,t,e.ctrlRadius)})),e.ctrlIndex>-1){var u=t(p[e.ctrlIndex],2),I=u[0],d=u[1];return void(e.remmber=[[c-I,h-d]])}var v=t(e.hoverOnShape(l),2),g=v[0],y=v[1],H=2===(null===(o=e.activeShape)||void 0===o?void 0:o.type)&&e.activeShape.creating;if(!H&&g>-1){if(e.emit("select",y),e.dataset.forEach((function(t,e){t.active=e===g})),y.dragging=!0,e.dataset.splice(g,1),e.dataset.push(y),e.remmber=[],3===y.type){var S=t(y.coor,2),E=S[0],m=S[1];e.remmber=[[c-E,h-m]]}else y.coor.forEach((function(t){e.remmber.push([c-t[0],h-t[1]])}));e.update()}else if(H){if(e.isInContent(n)){var T=e.activeShape,x=t(T.coor[T.coor.length-1],2);E=x[0],m=x[1];E!==c&&m!==h&&(T.coor.push([c-e.originX/e.scale,h-e.originY/e.scale]),e.update())}}else if(e.createType&&e.isInContent(n)){var G=void 0,b=[c-e.originX/e.scale,h-e.originY/e.scale];1===e.createType?(G=new i([b,b],e.dataset.length)).creating=!0:2===e.createType?(G=new a([b],e.dataset.length)).creating=!0:3===e.createType&&(G=new s(b,e.dataset.length),e.emit("add",G)),e.dataset.forEach((function(t){t.active=!1})),G.active=!0,G.uuid=r.createUuid(),e.dataset.push(G),e.update()}else e.activeShape&&(e.activeShape.active=!1,e.update())}})),this.canvas.addEventListener("mousemove",(function(i){var a,s,r=i.offsetX/e.scale,n=i.offsetY/e.scale;if(!e.lock)if(e.movePoint=[r,n],2===i.buttons&&3===i.which)e.originX=i.offsetX-e.remmberOrigin[0],e.originY=i.offsetY-e.remmberOrigin[1],e.update();else if(1===i.buttons){if(e.activeShape)if(e.ctrlIndex>-1){var o=t(e.remmber,1),c=t(o[0],2),h=c[0],l=c[1];if(e.emit("resize",e.activeShape),1===e.activeShape.type){var f=t(e.activeShape.coor,2),p=t(f[0],2),u=p[0],I=p[1],d=t(f[1],2),v=d[0],g=d[1],y=[];switch(e.ctrlIndex){case 0:y=[[r-h,n-l],[v,g]];break;case 1:y=[[u,n-l],[v,g]];break;case 2:y=[[u,n-l],[r-h,g]];break;case 3:y=[[u,I],[r-h,g]];break;case 4:y=[[u,I],[r-h,n-l]];break;case 5:y=[[u,I],[v,n-l]];break;case 6:y=[[r-h,I],[v,n-l]];break;case 7:y=[[r-h,I],[v,g]]}var H=t(y,2),S=t(H[0],2),E=S[0],m=S[1],T=t(H[1],2),x=T[0],G=T[1];x-E>=e.MIN_WIDTH&&G-m>=e.MIN_HEIGHT?e.activeShape.coor=y:e.emit("error","宽不能小于"+e.MIN_WIDTH+",高不能小于"+e.MIN_HEIGHT+"。")}else 2===e.activeShape.type&&e.activeShape.coor.splice(e.ctrlIndex,1,[r-e.originX/e.scale,n-e.originY/e.scale]);e.update()}else if(e.activeShape.dragging){y=[];var b=e.IMAGE_ORIGIN_WIDTH||e.WIDTH,M=e.IMAGE_ORIGIN_HEIGHT||e.HEIGHT;if(3===e.activeShape.type){var _=t(e.remmber[0],2),D=_[0];l=n-_[1];if((h=r-D)<0||h>b||l<0||l>M)return;y=[h,l]}else for(var k=0;k<e.activeShape.coor.length;k++){var A=e.remmber[k];h=r-A[0],l=n-A[1];if(h<0||h>b||l<0||l>M)return;y.push([h,l])}e.activeShape.coor=y,e.update()}else if(e.activeShape.creating&&1===e.activeShape.type&&e.isInContent(i)){h=r-e.originX/e.scale,l=n-e.originY/e.scale;e.activeShape.coor.splice(1,1,[h,l])}e.update()}else 2===(null===(a=e.activeShape)||void 0===a?void 0:a.type)&&(null===(s=e.activeShape)||void 0===s?void 0:s.creating)&&e.update()})),this.canvas.addEventListener("mouseup",(function(i){if(!e.lock&&(e.remmber=[],e.activeShape&&(e.activeShape.dragging=!1,e.activeShape.creating&&1===e.activeShape.type))){var a=t(e.activeShape.coor,2),s=t(a[0],2),r=s[0],n=s[1],o=t(a[1],2),c=o[0],h=o[1];Math.abs(r-c)<e.MIN_WIDTH||Math.abs(n-h)<e.MIN_HEIGHT?(e.dataset.pop(),e.emit("error","宽不能小于"+e.MIN_WIDTH+",高不能小于"+e.MIN_HEIGHT)):(e.activeShape.coor=[[Math.min(r,c),Math.min(n,h)],[Math.max(r,c),Math.max(n,h)]],e.activeShape.creating=!1,e.emit("add",e.activeShape)),e.update()}})),this.canvas.addEventListener("dblclick",(function(){var t;e.lock||2===(null===(t=e.activeShape)||void 0===t?void 0:t.type)&&e.activeShape.coor.length>2&&(e.emit("add",e.activeShape),e.activeShape.creating=!1,e.update())})),document.body.addEventListener("keyup",(function(t){if(!e.lock){var i=e.activeShape;2===(null==i?void 0:i.type)&&("Escape"===t.key?e.dataset.pop():"Backspace"===t.key&&(e.activeShape.coor.length>1?e.activeShape.coor.pop():e.dataset.pop()),e.update()),e.activeShape&&"Backspace"===t.key&&e.deleteByIndex(e.activeShape.index)}}))},r.createUuid=function(){for(var t=[],e="0123456789abcdef",i=0;i<36;i++)t[i]=e.substr(Math.floor(16*Math.random()),1);return t[14]="4",t[19]=e.substr(3&t[19]|8,1),t[8]=t[13]=t[18]=t[23]="-",t.join("")},r.prototype.setData=function(t){var e=this;t.forEach((function(t,n){if(Object.prototype.toString.call(t).indexOf("Object")>-1){var o=t.label,c=t.type,h=t.coor,l=t.uuid,f=void 0;switch(c){case 1:f=new i(h,n);break;case 2:f=new a(h,n);break;case 3:f=new s(h,n)}f.label=(o||"").toString(),f.uuid=l||r.createUuid(),e.dataset.push(f)}else e.emit("error",t+" in data must be an enumerable Object.")})),this.update()},r.prototype.hoverOnShape=function(t){var e=this,i=-1,a=this.dataset.reduceRight((function(a,s,r){return a||(3===s.type&&e.isPointInCircle(t,s.coor,3)||1===s.type&&e.isPointInRect(t,s.coor)||2===s.type&&e.isPointInPolygon(t,s.coor))&&(i=r,a=s),a}),null);return[i,a]},r.prototype.isInContent=function(t){var e=t.offsetX/this.scale,i=t.offsetY/this.scale;return e>=this.originX/this.scale&&i>=this.originY/this.scale&&e<=this.originX/this.scale+this.IMAGE_ORIGIN_WIDTH&&i<=this.originY/this.scale+this.IMAGE_ORIGIN_HEIGHT},r.prototype.isPointInRect=function(e,i){var a=this,s=t(e,2),r=s[0],n=s[1],o=t(i.map((function(t){return t.map((function(t){return t*a.scale}))})),2),c=t(o[0],2),h=c[0],l=c[1],f=t(o[1],2),p=f[0],u=f[1];return h+this.originX<=r&&r<=p+this.originX&&l+this.originY<=n&&n<=u+this.originY},r.prototype.isPointInPolygon=function(e,i){var a=this;this.offlineCtx.save(),this.offlineCtx.clearRect(0,0,this.WIDTH,this.HEIGHT),this.offlineCtx.translate(this.originX,this.originY),this.offlineCtx.beginPath(),i.forEach((function(e,i){var s=t(e.map((function(t){return Math.round(t*a.scale)})),2),r=s[0],n=s[1];0===i?a.offlineCtx.moveTo(r,n):a.offlineCtx.lineTo(r,n)})),this.offlineCtx.closePath(),this.offlineCtx.fill();var s=this.offlineCtx.getImageData(0,0,this.WIDTH,this.HEIGHT),r=(e[1]-1)*this.WIDTH*4+4*e[0];return this.offlineCtx.restore(),0!==s.data[r+3]},r.prototype.isPointInCircle=function(e,i,a){var s=this,r=t(e,2),n=r[0],o=r[1],c=t(i.map((function(t){return t*s.scale})),2),h=c[0],l=c[1];return Math.sqrt(Math.pow(h+this.originX-n,2)+Math.pow(l+this.originY-o,2))<=a},r.prototype.drawRect=function(e){var i=this;if(2===e.coor.length){var a=t(e.coor.map((function(t){return t.map((function(t){return Math.round(t*i.scale)}))})),2),s=t(a[0],2),r=s[0],n=s[1],o=t(a[1],2),c=o[0],h=o[1];this.ctx.save(),this.ctx.fillStyle=this.fillStyle,this.ctx.strokeStyle=e.active||e.creating?this.activeStrokeStyle:this.strokeStyle;var l=c-r,f=h-n;this.ctx.strokeRect(r,n,l,f),e.creating||this.ctx.fillRect(r,n,l,f),this.ctx.restore(),this.drawLabel(e.coor[0],e.label)}},r.prototype.drawPolygon=function(e){var i=this;if(this.ctx.save(),this.ctx.fillStyle=this.fillStyle,this.ctx.strokeStyle=e.active||e.creating?this.activeStrokeStyle:this.strokeStyle,this.ctx.beginPath(),e.coor.forEach((function(e,a){var s=t(e.map((function(t){return Math.round(t*i.scale)})),2),r=s[0],n=s[1];0===a?i.ctx.moveTo(r,n):i.ctx.lineTo(r,n)})),e.creating){var a=t(this.movePoint.map((function(t){return Math.round(t*i.scale)})),2),s=a[0],r=a[1];this.ctx.lineTo(s-this.originX,r-this.originY)}else e.coor.length>2&&this.ctx.closePath();this.ctx.fill(),this.ctx.stroke(),this.ctx.restore(),this.drawLabel(e.coor[0],e.label)},r.prototype.drawDot=function(e){var i=this,a=t(e.coor.map((function(t){return t*i.scale})),2),s=a[0],r=a[1];this.ctx.save(),this.ctx.fillStyle=this.ctrlFillStyle,this.ctx.strokeStyle=e.active?this.activeStrokeStyle:this.strokeStyle,this.ctx.beginPath(),this.ctx.arc(s,r,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.arc(s,r,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore(),this.drawLabel(e.coor,e.label)},r.prototype.drawCtrl=function(e){var i=this,a=t(e.map((function(t){return t*i.scale})),2),s=a[0],r=a[1];this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle=this.ctrlFillStyle,this.ctx.strokeStyle=this.ctrlStrokeStyle,this.ctx.arc(s,r,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.arc(s,r,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore()},r.prototype.drawCtrlList=function(t){var e=this;t.ctrlsData.forEach((function(t){e.drawCtrl(t)}))},r.prototype.drawLabel=function(e,i){var a=this;if(void 0===i&&(i=""),i.length){var s=i.length<this.labelMaxLen+1?i:i.substr(0,this.labelMaxLen)+"...",r=this.ctx.measureText(s),n=t(e.map((function(t){return t*a.scale})),2),o=n[0],c=n[1],h=this.IMAGE_ORIGIN_WIDTH-e[0]<(r.width+4)/this.scale,l=this.IMAGE_ORIGIN_HEIGHT-e[1]<16/this.scale;this.ctx.save(),this.ctx.fillStyle=this.labelFillStyle,this.ctx.fillRect(h?o-r.width-3:o+1,l?c-15:c+1,r.width+4,16),this.ctx.font=this.labelFont,this.ctx.strokeText(s,h?o-r.width-2:o+2,l?c-4:c+12,80),this.ctx.restore()}},r.prototype.paintImage=function(){this.ctx.drawImage(this.image,0,0,this.IMAGE_WIDTH,this.IMAGE_HEIGHT)},r.prototype.clear=function(){this.ctx.clearRect(0,0,this.WIDTH,this.HEIGHT)},r.prototype.update=function(){var t=this;this.ctx.save(),this.clear(),this.ctx.translate(this.originX,this.originY),this.paintImage(),this.dataset.forEach((function(e){switch(e.type){case 1:t.drawRect(e);break;case 2:t.drawPolygon(e);break;case 3:t.drawDot(e)}})),this.activeShape&&[1,2].includes(this.activeShape.type)&&this.drawCtrlList(this.activeShape),this.ctx.restore()},r.prototype.deleteByIndex=function(t){var e=this.dataset.findIndex((function(e){return e.index===t}));e>-1&&(this.emit("delete",this.dataset[e]),this.dataset.splice(e,1),this.dataset.forEach((function(t,e){t.index=e})),this.update())},r.prototype.calcStep=function(t){t&&(this.scaleStep=100,this.setScale(!1)),(this.IMAGE_WIDTH>this.WIDTH||this.IMAGE_HEIGHT>this.HEIGHT)&&(this.setScale(!1),this.calcStep())},r.prototype.setScale=function(t){if(!this.lock&&!(!t&&this.IMAGE_WIDTH<=20||t&&this.IMAGE_WIDTH>=100*this.WIDTH)){t?this.scaleStep++:this.scaleStep--;var e=Math.abs(this.scaleStep),i=this.IMAGE_WIDTH;this.IMAGE_WIDTH=Math.round(this.IMAGE_ORIGIN_WIDTH*Math.pow(this.scaleStep>=0?1.05:.95,e)),this.IMAGE_HEIGHT=Math.round(this.IMAGE_ORIGIN_HEIGHT*Math.pow(this.scaleStep>=0?1.05:.95,e)),this.stayPosition(this.IMAGE_WIDTH/i),this.update()}},r.prototype.fitZoom=function(){this.calcStep(!0),this.IMAGE_HEIGHT/this.IMAGE_WIDTH>=this.HEIGHT/this.WIDTH?(this.IMAGE_WIDTH=this.IMAGE_ORIGIN_WIDTH/(this.IMAGE_ORIGIN_HEIGHT/this.HEIGHT),this.IMAGE_HEIGHT=this.HEIGHT):(this.IMAGE_WIDTH=this.WIDTH,this.IMAGE_HEIGHT=this.IMAGE_ORIGIN_HEIGHT/(this.IMAGE_ORIGIN_WIDTH/this.WIDTH)),this.originX=(this.WIDTH-this.IMAGE_WIDTH)/2,this.originY=(this.HEIGHT-this.IMAGE_HEIGHT)/2,this.update()},r.prototype.stayPosition=function(t){this.originX=this.WIDTH/2-(this.WIDTH/2-this.originX)*t,this.originY=this.HEIGHT/2-(this.HEIGHT/2-this.originY)*t},r.prototype.on=function(t,e){var i=this.EventList[t];Array.isArray(i)?i.push(e):this.EventList[t]=[e]},r.prototype.emit=function(i){for(var a=[],s=1;s<arguments.length;s++)a[s-1]=arguments[s];var r=this.EventList[i];Array.isArray(r)&&r.forEach((function(i){return i.apply(void 0,e([],t(a)))}))},r.prototype.off=function(t,e){var i=this.EventList[t],a=i.find((function(t){return t===e}));Array.isArray(i)&&a&&i.splice(a,1)},r}()}));
//# sourceMappingURL=canvas-select.min.js.map
